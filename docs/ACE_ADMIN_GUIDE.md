# ACE 人工介入调整指南

## 概述

ACE (Agentic Context Engineering) 是一个自进化交易系统，但在实际运行中需要人工介入来监督和调整。本指南介绍了如何在 ACE 模式下进行人工干预。

## 人工介入的层次

### 1. 知识库层面（推荐）✅
通过调整知识库来引导系统学习方向，这是最推荐的介入方式。

**优点：**
- 不破坏系统的自主性
- 可以长期影响决策模式
- 符合 ACE 的设计理念

**方式：**
- 手动添加成功经验
- 调整条目置信度
- 删除有害经验
- 标记有效/无效条目

### 2. 配置层面 ⚙️
调整系统运行参数。

**可调整项：**
- `config/config.yaml` - 策略配置
- `prompts/ace_system.txt` - System Prompt
- `迭代间隔` - 交易频率
- `检索参数` - 知识检索数量和阈值

### 3. 紧急停止 🛑
通过 `Ctrl+C` 中断系统运行。

---

## 使用 ACE 管理工具

### 启动管理工具

```bash
uv run python ace_admin.py
```

### 主要功能

#### 1. 📊 查看知识库统计
查看整体运行情况：
- 知识条目数量
- 执行轨迹数量
- 反思记录数量
- 条目类型分布

**使用时机：** 定期检查（每天/每周）

#### 2. 📚 浏览知识条目
查看系统学到的知识：
- 按置信度排序
- 查看内容和使用次数
- 识别高质量/低质量条目

**示例输出：**
```
1. [pattern] ID: 8a7f3c2e...
   置信度: 85.00%
   内容: 当 BTC 突破 EMA200 且 RSI>70，应避免追高开多...
   使用次数: +12 / -2 / =3
   创建时间: 2024-01-15 10:30:00
```

#### 3. ✏️ 编辑条目置信度

**场景 1：发现有效经验**
```
选择: 3 (编辑置信度)
输入 ID: 8a7f3c2e
选择: 1 (标记为有效)
✅ 已标记为有效，新置信度: 90.00%
```

**场景 2：发现有害经验**
```
选择: 3 (编辑置信度)
输入 ID: 5b2d9f1a
选择: 2 (标记为无效)
✅ 已标记为无效，新置信度: 25.00%
```

**场景 3：手动设置**
```
选择: 3 (编辑置信度)
输入 ID: c4e8a1b2
选择: 3 (手动设置)
helpful_count: 20
harmful_count: 1
✅ 已更新，新置信度: 95.24%
```

#### 4. ➕ 手动添加经验条目

当你有明确的交易经验时，可以手动注入知识库：

**示例：添加风控规则**
```
选择: 4 (手动添加)
选择类型: 2 (RULE - 规则)
内容: 单笔交易亏损超过 2% 必须立即止损，不可犹豫
标签: risk_management, stop_loss
✅ 已添加条目: f9a3d7e1...
```

**条目类型说明：**
- **PATTERN (模式)**: 市场规律，如 "BTC 突破 50000 后通常有回调"
- **RULE (规则)**: 交易规则，如 "单次仓位不超过 5%"
- **INSIGHT (洞察)**: 深层理解，如 "高资金费率表示市场过热"
- **MISTAKE (错误)**: 失败教训，如 "不在高波动时段开仓"
- **CONTEXT (上下文)**: 市场环境，如 "熊市初期应降低杠杆"

#### 5. 🗑️ 删除不良条目

删除明显错误或过时的知识：

```
选择: 5 (删除条目)
输入 ID: 3c5e1a2b
确认删除? yes
✅ 已删除
```

**删除建议：**
- 置信度 < 0.2 的条目
- 长时间未使用的旧条目
- 与当前市场环境不符的经验

#### 6. 📜 查看执行历史

查看最近的交易决策和结果：

```
选择: 6 (查看执行历史)
显示数量: 20

📜 执行历史 (最近 20 条):

1. ✅ 2024-01-20 15:30:00
   决策数量: 2
     - BTC/USDC:USDC: open_long (置信度: 75.00%)
     - ETH/USDC:USDC: hold (置信度: 60.00%)
   盈亏: +125.50 USDC

2. ❌ 2024-01-20 12:00:00
   决策数量: 1
     - BTC/USDC:USDC: close (置信度: 80.00%)
   错误: Order price cannot be more than 95% away from the reference price
```

#### 7. 🤔 查看反思记录

了解系统的自我评估：

```
选择: 7 (查看反思记录)

🤔 反思记录 (最近 10 条):

1. ❌ 2024-01-20 15:35:00
   失败类型: execution_error
   关键洞察:
     - 在高波动期间执行交易容易失败
     - 应该在下单前检查价格偏离度
   改进建议:
     - 添加价格偏离检查逻辑
     - 使用更保守的滑点设置
```

#### 8. 💾 导出知识库

备份当前知识库：

```
选择: 8 (导出知识库)
文件名: ace_backup_20240120.json
✅ 已导出 150 个条目到 ace_backup_20240120.json
```

**用途：**
- 定期备份
- 在不同环境间迁移知识
- 分析知识库演化

#### 9. 🧹 清理知识库

定期清理无效数据：

```
选择: 10 (清理知识库)
选择: 1 (删除低置信度条目)
✅ 已删除 15 个低置信度条目
```

**清理建议：**
- 每周清理一次低置信度条目（< 0.2）
- 每月归档一次长期未使用的条目（> 90天）

---

## 最佳实践

### 1. 定期监督流程

**每日：**
- 查看执行历史（最近 10-20 条）
- 检查是否有异常决策
- 查看反思记录中的新洞察

**每周：**
- 查看知识库统计
- 浏览高/低置信度条目
- 清理低质量条目

**每月：**
- 导出知识库备份
- 归档旧条目
- 评估整体表现

### 2. 何时手动调整置信度

**提升置信度 (+1 helpful)：**
- 决策后带来稳定盈利
- 成功规避了风险
- 符合你的交易理念

**降低置信度 (+1 harmful)：**
- 导致亏损
- 违反风控规则
- 在当前市场环境下失效

### 3. 何时手动添加条目

**推荐添加：**
- 你的成功交易经验
- 明确的风控规则
- 市场规律的总结
- 重要的失败教训

**不推荐添加：**
- 模糊的感觉
- 短期偶然事件
- 未经验证的假设

### 4. 紧急情况处理

**市场剧烈波动：**
```bash
# 1. 立即停止系统
Ctrl+C

# 2. 检查当前持仓
# 使用交易所界面或 API

# 3. 手动平仓（如果需要）

# 4. 修改配置降低风险
vim config/config.yaml
# 降低仓位、增加止损等

# 5. 重新启动
uv run python main_ace.py
```

**发现系统异常：**
```bash
# 1. 停止系统
Ctrl+C

# 2. 查看最近的决策
uv run python ace_admin.py
# 选择: 6 (查看执行历史)

# 3. 查看反思记录
# 选择: 7 (查看反思记录)

# 4. 找出问题条目并删除或降低置信度

# 5. 重新启动
```

---

## 配置文件调整

### 修改交易参数

编辑 `config/config.yaml`:

```yaml
strategy:
  interval_seconds: 300  # 调整迭代间隔（秒）
  symbols:
    - "BTC/USDC:USDC"
    - "ETH/USDC:USDC"

  # 可以添加其他参数
  max_position_size: 0.05  # 最大仓位比例
  stop_loss_percent: 0.02  # 默认止损比例
```

### 修改 System Prompt

编辑 `prompts/ace_system.txt`:

```
你是一个专业的加密货币交易智能体...

【风险控制原则】
- 单笔交易风险不超过账户的 2%
- 必须设置止损
- 避免在高波动时段频繁交易

【添加你的其他原则】
...
```

---

## 常见问题

### Q1: 置信度是如何计算的？
A: 置信度 = helpful / (helpful + harmful)
- helpful_count: 标记为有效的次数
- harmful_count: 标记为无效的次数

### Q2: 多久清理一次知识库？
A: 建议：
- 每周清理低置信度条目（< 0.2）
- 每月归档长期未使用条目（> 90天）

### Q3: 可以完全依赖 ACE 自动交易吗？
A: 不建议。应该：
- 定期人工监督（每天）
- 设置风控上限
- 在关键时刻人工介入

### Q4: 如何恢复误删的条目？
A:
- 从备份文件恢复（如果有导出）
- 从 execution_traces 表中找到原始决策
- 无法恢复则重新手动添加

### Q5: 知识库多大才算合适？
A:
- 初期：50-100 个高质量条目
- 成熟：200-500 个条目
- 过多（> 1000）可能影响检索效率

---

## 总结

ACE 的人工介入应该遵循以下原则：

1. **引导而非控制** - 通过调整知识库引导学习方向
2. **定期监督** - 每天查看执行历史和反思
3. **及时干预** - 发现异常立即停止
4. **持续优化** - 定期清理和调整知识库

记住：ACE 是自进化系统，人工介入应该是**导师**而非**替代者**。
